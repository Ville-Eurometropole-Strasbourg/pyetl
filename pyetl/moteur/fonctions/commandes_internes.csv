!att_tri1;valeur_tri1;att_tri2;valeur_tri2;att_sortie;defaut;att_entree;mode;param1;param2;fin;
!============================== bloc utilitaires ===========================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#stdvar;;;;;;;;;;
#!help;variables de base appele par tous les autres elements p:format: format de sortie>acces: acces base de donnees si necessaire;;;;;;;;;;
$F_sortie=%format%;txt;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
K:%F_sortie%:sql;$format_schema=%F_sortie%;
$#%acces%;%acces%;;;;;;;;;;
$#%dest%;%acces%;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#gid;;;;;;;;;;
#!help;ajout d un gid si necessaire;;;;;;;;;;
;has:PK;;;;;;pass;;;fin;
|sinon:gid;;;;gid_orig;;gid;ren;;;fin;
|:;;;;gid(0:S,P);;#classe;cnt;1;1;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#att_sigli_std;;;;;;;;;;
#!help;ajoute les attributs standard  date_maj / date_creation;;;;;;;;;;
;;;;date_maj(D,D:A);;#_date_sys_mod;set;;;fin;
;;;;date_creation(D,D:I);;#_date_sys_cre;set;;;fin;
<#gid
!===========================================================================================;;;;;;;;;;;
&&#define;#att_sigli_modif;;;;;;;;;;
#!help;ajoute les attributs standard  date_maj / date_creation;;;;;;;;;;
;;;;auteur(T,D:A);;auteur;set;;;fin;
<#att_elyx_std
!===========================================================================================;;;;;;;;;;;
&&#define;#cmin;passe les noms de classe en minuscules ;;;;;;;;;
#!help;passe les noms de classe en minuscules ;;;;;;;;;;
;;;;#classe;;#classe;lower;;;fin;
;;;;#groupe;;#groupe;lower;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#groupe;groupe;;;;;;;;;
#!help;force le groupe p:groupe: nouveau groupe;;;;;;;;;;
;;;;#groupe;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#prefix;prefix;;;;;;;;;
#!help;prefixe la classe p:prefix: prefixe a ajouter a la classe;;;;;;;;;;
;;;;+#classe;%prefix%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#rename;old;new;;;;;;;
#!help:modifie la classe p:old: partie a remplacer >new: partie de remplacement;;;;;;;;;
;;;;#classe;;#classe;sub;%old%;%new%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#regroupe;groupe;stocke_groupe;;;;;;;;
#!help;force le groupe et le transfere sur un attribut p:groupe: nom du nouveau groupe>attribut: nom de l'attribut contenant l'ancien;;;;;;;;;;
;;;;%stocke_groupe%;;#groupe;set;;;fin;
;;;;#groupe;%groupe%;;set;;;fin;
;;;;#schema;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#version;full;affiche la version du logiciel ;;;;;;;;;
#!help;affiche la version de pyetl;;;;;;;;;;
;;;;;;;version;%full%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#set;atts;vals;defaut;;;;;;;
#!help ;affectation  absolue de champs; ;;;;;;;;;
;;;;%atts%;%defaut%;%vals%;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cmd;cmd;v1;v2;v3;v4;v5;;;;
#!help ;passe une commande a la sauvage; ;;;;;;;;;
;;;;%v1%;%v2%;%v3%;%cmd%;%v4%;%v5%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#mod;att;val;repl;;;;;;;
#!help ;modif conditionelle de valeurs dans un champs; ;;;;;;;;;
%att%;%val%;;;%att%;%repl%;;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fanout;;;;;;;;;;
$mode_sortie=C;;;;;;;;;;;
$fanout=file;;;;;;;;;;;
$F_sortie=%format%;asc;;;;;;;;;;

!========================= lecture donnees ============================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#extract;niveau;classe;;;;;;;;
#!help;extraction de niveaux ou de classes;;;;;;;;;;
<#stdvar;;;;;;;;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;fin;
#groupe;%niveau%;#classe;%classe%;;;;pass-;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#extract+gid;niveau;classe;;;;;;;;;;
#!help;lecture d'un jeu de donnees d' une base avec ajout d un gid si necessaire p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
<#extract;%niveau%;%classe%;;;;;;;;;;;
<#gid;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#valide;niveau;classe;;;;;;;;
#!help;validation de niveaux ou de classes;;;;;;;;;;
<#stdvar;txt;;;;;;;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;fin;
#groupe;%niveau%;#classe;%classe%;;;;valide_schema;;;fin;10,date_creation
!===========================================================================================;;;;;;;;;;;
&&#define;#analyse;;;;;;;;;;
#!help;analyse d'un jeu de donnees p:format force ;;;;;;;;;;
$format_schema=csv,xml,sql;;;;;;;;;;;
$max_conf=%max_conf%;40;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
!;;;;;;#schema;supp;;;;
;;;;;;;schema>;%nom%;%max_conf%;;
!=================================== acces bases de donnees ================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbaccess;acces;base;serveur;type;user;pass;;;;
#!help;positionne des elements d'acces a une base de donnees en direct;;;;;;;;;;
$base_%acces%=%base%;;;;;;;;;;;
$server_%acces%=%serveur%;;;;;;;;;;;
$db_%acces%=%type%;;;;;;;;;;;
$sitedef_%acces%='ok';;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#initdb;acces;nom;;;;;;;
#!help;positionne des elements d'acces a une base de donnees;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$format_schema=%format_schema%;csv,xml;;;;;;;;;;
$nom=%nom%;%acces%;extraction;;;;;;;;;
$xmlheader=%xmlheader%;;;;;;;;;;;
$xmlalias=%alias%;;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
$#%acces%;%acces%;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbschema;acces;niveau;classe;nom;;;;;;
#!help;analyse une base de donnees;;;;;;;;;;
<#initdb;%acces%;%nom%;;;;
$force_schema=used;;;;;;;;;;;
db:%acces%;%niveau%;%classe%;;;%nom%;;dbschema;%mod%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbclean;acces;niveau;classe;nom;;;;;;
#!help;cree un script de reset de la base de donnees;;;;;;;;;;
<#initdb;%acces%;%non%;;;;
db:%acces%;%niveau%;%classe%;;;;;dbclean;T,=;%nom%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbextract;acces;niveau;classe;attribut;valeur;ordre;;;;
#!help;extraction d'un jeu de donnees d'une base de données;;;;;;;;;;
!$mode_sortie=D;;;;;;;;;;;
!<#initdb;%acces%;;;;;
!$#%dest%;%acces%;;;;;;;;;;
<#stdvar;;;;;;;;
!p:schema;;;;schema_entree;;;lire_schema;%schema%;csv;fin;
!p:dest;;;;;;;pass;;;fin;
!+:db:%base#dest%;;;;schema_sortie;;;dbschema;;;fin;
db:%acces%;%niveau%;%classe%;%attribut%;;%valeur%;;dbalpha;%mod%;%ordre%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbdump;acces;niveau;classe;rep_sortie;log;;;
#!help;extraction d'un jeu de donnees d'une base de données avec un programme externe;;;;;;;;;;
<#stdvar;;;;;;;;
db:%acces%;%niveau%;%classe%;;;;;dbextdump;%rep_sortie%;%log%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#geoextract;acces;niveau;classe;mode_geo;buffer;;;;;
#!help;extraction d'un jeu de donnees d' une base par emprise p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
<#initdb;%acces%;;;;;
$mode_geo=dans_emprise;;;;;;;;;;;
$#%dest%;dest;;;;;;;;;;
db:%acces%;%niveau%;%classe%;dans_emprise;;buffer;;dbgeo;%mod%;%ordre%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbextract+gid;acces;niveau;classe;attribut;valeur;;;;;
#!help;lecture d'un jeu de donnees d' une base avec ajout d un gid si necessaire p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
<#dbextract;%acces%;%niveau%;%classe%;%attribut%;%valeur%;;;;;;
<#gid;;;;;;;;;;;

!========================= conversion ======================================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#to_sigli;;;;;;;;;;
#!help;preparation d'un jeu de donnees formatage standard sigli p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
$format=sql;;;;;;;;;;;
<#extract+gid;;;;;;;;;;;
<#att_sigli_std;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#ora2pg;;;;;;;;;;
#!help;passage de oracle vers postgis;;;;;;;;;;
$codec_sortie=utf-8;;;;;;;;;;;
$F_sortie=txt;;;;;;;;;;;
<#dbextract+gid;;;;;;;;;;;
<#cmin;;;;;;;;;;;
p:groupe;;;;#groupe;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#sigli2elyx;passage de sigli vers elyx : sortie asc suppression GID renommage attributs modifies;;;;;;;;;
#!help;passage de sigli vers elyx : sortie asc suppression GID renommage attributs modifies;;;;;;;;;;
$codec_sortie=cp1252;;;;;;;;;;;
<#dbextract;;;;;;;;;;;
$F_sortie=asc;;;;;;;;;;;
type_entite;;;;type;;type_entite;ren;;;fin;
gid;;;;#gid;;gid;set;;;fin;
+:;;;;;;gid;supp;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#g2p;lon;lat;;;;;;;;
#!help;convertit des coordonees lat long en attribut en point cc48;;;;;;;;;;
;;;;;0;%lon%,%lat%;setpoint;;;fin;
;;;;;LL;;reproj;CC48;NG;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cus2cc48;;;;;;;;;;
#!help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;L1;;reproj;CC48;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cc2cus;;;;;;;;;;
#!help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;CC48;;reproj;L1;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#2p;lon;lat;;;;;;;;
#!help;convertit des coordonees x,y en attribut en point cc48;;;;;;;;;;
;;;;;0;%X%,%Y%;setpoint;;;fin;
!============================ manipulation schemas =========================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fusion_schema;nom;;;;;;;;;
#!help;fusion de schemas issus de traitements paralleles p:schema: racine des schemas a lire (*) lecture multiple >nom: nom du schema a créer;;;;;;;;;;
$format_schema=csv,xml;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$nom=%nom%;fusion;;;;;;;;;;
;;;;#schema;%nom%;;lire_schema;%schema%;csv;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cree_sql;nom;schema;dest;;;;;;;
#!help;conversion de schemas en sql p:schema: racine des schemas a lire (*) lecture multiple >nom: nom du schema a créer;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$dest=%dest%;sigli;;;;;;;;;;
$nom=%nom%;donnees;;;;;;;;;;
$format_schema=sql:%dest%,csv;;;;;;;;;;;
;;;;;;;start;;;;
;;;;#schema;%nom%;;lire_schema;%nom%;csv;fin;
<#gid;;;;;;;;;;;
schema:#modif;;;;;;;pass;;;
|:<#att_sigli_std;;;;;;
!============================= manipulation des parametres =================================;;;;;;;;;;fin;
!===========================================================================================;;;;;;;;;;fin;
&&#define;#site_params;key;;;;;;;;fin;
#!help;affichage des parametres de connection stockes;;;;;;;;;fin;
$sans_sortie=True;;;;;;;;;;fin;
$_entree=%_paramdir%\site_params.csv;;;;;;;;;;fin;
$force_schema=0;;;;;;;;;;fin;
clef;&&#set;;;groupe;;valeur;set;;;fin;
+:;;;;;;groupe;print>;---------;noms;fin;
clef;passwd;p:printpv;!force;valeur;******;;set;;;fin;
clef;\*\*passwd;p:key;;valeur;;valeur;decrypt;%key%;;fin;
clef;!:null;;;;;clef,valeur;print>;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#pwcrypt;key;;;;;;;;;
#!help;crypte les mots de passe;;;;;;;;;;
$_entree=%_paramdir%\site_params_nc.csv;;;;;;;;;;;
$_sortie=%_paramdir%;;;;;;;;;;;
$F_sortie=csv;;;;;;;;;;;
"$separ_csv_out=\;";;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
$key=%key%;;;;;;;;;
;;;;#classe;site_params_c;;set;;;;
clef;passwd;;;valeur;;valeur;crypt;%key%;;;
+:;;;;+clef;**;;set;;;fin;
clef;!'';;;;;clef,valeur;print;;;fin;
;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#printparams;;;;;;;;;;
#!help;affichage;;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
;;;;;;*;print>;#classe;noms;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#printvar;var;;;;;;;;;
#!help;affichage variable;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
;;;;%var%;%%var%%;;set;;;debug
;;;;;%var%;;print>;#classe;noms;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#pyetl_init_db;initialise le schema pyetl pour travailler en base de donnees;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$format_schema=sql,csv;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$nom=pyetl;;;;;;;;;;;
$schema=%_progdir%\moteur\db_struct\pyetl;;;;;;;;;;;
;;;;#schema;%nom%;;lire_schema;%schema%;csv;fin;
!========================================mode batch===================================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_list_batch;bdef;sortie;;;;;;;;
#!help;liste des batchs definis en base ;;;;;;;;;;
$mode_sortie=A;;;;;;;;;;;
$F_sortie=%sortie%;print;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$bdef=%bdef%;batchmode;;;;;;;;;;
$#%bdef%;;;;;;;;;;;
$ordrebatch=famille,ordre;;;;;;;;;;;
<#dbextract;%batchserver%;%batchschema%;%batchtable%;;;%ordrebatch%;;;;;
p:nom;;;;;;;pass;;;;
+:nom;!%nom%;;;;;;pass>;;;;
p:famille;;;;;;;pass;;;;
+:famille;!%famille%;;;;;;pass>;;;;
p:sortie;print;;;;;;tmpstore;;;;
+:;;;;;;nom,famille,ordre,commentaire;print>;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_batch;nom;famille;;;;;;;;
#!help;passe les batchs actifs;;;;;;;;;;
<#db_list_batch;;;;;;;;;;;
p:nom;;;;;;;pass;;;;
+:nom;!%nom%;;;;;;pass>;;;;
p:famille;;;;;;;pass;;;;
+:famille;!%famille%;;;;;;pass>;;;;
actif;True;;;succes;;;batch;;;;
;;;;;;;pass>;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#runsql;nom;dest;;;;;;;;
#!help;lancement script_sql;;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$#%dest%;%dest%;;;;;;;;;;
db:%dest%;;;;;%nom%.sql;;runsql;%log%;%sortie%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#autoload;dest;;;;;;;;;
#!help;charge les derniers resultats en base de donnees;;;;;;;;;;
$_entree=!!vide;;;;;;;;;;;
$#%dest%;%dest%;;;;;;;;;;
db:%dest%;;;;;%derniere_sortie%;;runsql;%log%;;debug;
!===========================================================================================;;;;;;;;;;;
&&#define;#zip;source;destination;;;;;;;;
#!help;zippe les resultats;;;;;;;;;;
$_entree=!!vide;;;;;;;;;;;
;;;;;%_sortie%/%source%;;archive;%_sortie%/%destination%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#filter;champ;val_champ;;;;;;;;
#!help;mange tous les objets qui ne satisfont pas la condition ;;;;;;;;;;
%champ%;%val_champ%;;;;;;pass-;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#set;atts;vals;defaut;;;;;;;
#!help ;affectation  absolue de champs; ;;;;;;;;;
;;;;%atts%;%defaut%;%vals%;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cmd;cmd;v1;v2;v3;v4;v5;;;;
#!help ;passe une commande a la sauvage; ;;;;;;;;;
;;;;%v1%;%v2%;%v3%;%cmd%;%v4%;%v5%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#mod;att;val;repl;;;;;;;
#!help ;modif conditionelle de valeurs dans un champs; ;;;;;;;;;
%att%;%val%;;;%att%;%repl%;;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#indb;acces;;;;;;;;;
#!help;precharge des donnees depuis une base pour comparaison;;;;;;;;;;
db:%acces%;[#niveau];[#classe];;;;;dbalpha;=;;fin;
;;;;;P:#pk;;sortir;#store;nom;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#bdiff;acces;;;;;;;;;
#!help;sort un objet s il n existe pas en base;;;;;;;;;;
[#niveau];;[#classe];;cmp;P:#pk;;preload;#indb;;fin;
P:#pk;!in:#cmp;;;;;;pass>;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#grid;x_orig;y_orig;pas;cases;;;;;;
#!help;repartit les objets selon une grille;;;;;;;;;;
;;;;%case%_x;;;gridx;%x_orig%;%pas%;;
;;;;%case%_y;;;gridy;%y_orig%;%pas%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#upload;fich;dest;;;;;
#!help;charge des elements par ftp;;;;;;;;;;
$#ftp_%dest%;;;;;;
;;;;;%_sortie%/%fich%;;ftp_upload;ftp_%dest%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#geocode;adresse;filtres;;;;
#!help;geocode des elements;commande;parametres;;;;;;;;
"$separ_csv_out=\;";;;
;;;;;;%adresse%;geocode;%prefix%;%filtres%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#run;prog;params;;;;
#!help;execute une commande externe;commande;parametres;;;;;;;;
;;;;;;;run;%prog%;%params%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#editparams;perso;;;;;
$fich=%_paramdir%
K:perso;$fich=%_paramperso%
;;;;;;;run;notepad;%fich%\site_params.csv;;
!===========================================================================================;;;;;;;;;;;
&&#define;#test;n1;n2;;;;;
#!help;test des variables;;;
$test_v1=%n1%;;;;;
$test_v2=%n2%;;;;;
;;;;;;;printv>;;;;


