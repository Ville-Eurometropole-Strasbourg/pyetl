!att_tri1;valeur_tri1;att_tri2;valeur_tri2;att_sortie;defaut;att_entree;mode;param1;param2;debug;variables;
!============================== bloc utilitaires ===========================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#init_mp;;;;;;;;;;
!#help;initialise un module en mode multiprocessing (ne fait rien et attends)
;;;;;;;idle;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#pass;;;;;;;;;;
!#help;placeholdermacro: s'il faut une macro qui ne fait rien(ne fait rien et passe les objets)
;;;;;;;pass;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#stdvar;;;;;;;;;;
!#help;variables de base appele par tous les autres elements
!#variables;format; format de sortie defaut csv
!#variables;acces; acces base de donnees si necessaire;;;;;;;;;;
!#variables;dest; acces base de donnees en sortie si necessaire;;;;;;;;;;
$F_sortie=%format%;%F_sortie%;csv;;;;;;;;;
$mode_sortie=%mode_sortie%;D;;;;;;;;;;
K:%F_sortie%=sql;$format_schema=%F_sortie%;
$#%acces%;;;;;;;;;;;
$#%dest%;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#gid;;;;;;;;;;
!#help;ajout d un gid si necessaire;;;;;;;;;;
!#description;le gid n est ajoute que si la classe n'a pas de clef primaire;;;
;has:PK;;;;;;pass;;;fin;
|sinon:gid;;;;gid_orig;;gid;ren;;;fin;
|:#gid;;;;gid(0:S,P);;#gid;set
||sinon:;;;;gid(0:S,P);;#classe;cnt;1;1;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#att_sigli_std;;;;;;;;;;
!#help;ajoute les attributs standard  date_maj / date_creation et le gid;;;;;;;;;;
;;;;date_creation(D,D:I);;#_sys_date_cre;set;;;;
<#gid
!===========================================================================================;;;;;;;;;;;
&&#define;#att_sigli_modif;;;;;;;;;;
!#help;ajoute les attributs standard + date_maj et auteur ;;;;;;;;;;
<#att_sigli_std
;;;;date_maj(D,D:A);;#_sys_date_mod;set;;;fin;
;;;;auteur(T,D:A);;auteur;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#att_sigli;modif;;;;;;;;;
!#help;ajoute les attributs standard a un schema;
!#parametres;modif;0/1 ou f/t indique si la classe doit etre modifiee;
!;;;;;;;print;valeur de modif:%modif%;;
P:modif;;;;;;;pass;;;
|:<#att_sigli_modif;;;;;;
|sinon:<#att_sigli_std;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cmin;;;;;;;;;;
!#help;passe les noms de classe et de groupe en minuscule;;
;;;;#classe;;#classe;lower;;;fin;
;;;;#groupe;;#groupe;lower;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#linefilter;;;;;;;;;;
!#help;filtre les lignes pour eviter les erreurs;;;;;
#type_geom;2;schema:type_geom;3;#classe+;_l;;set;;;fin;
+:;;;;;;;force_ligne;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#geomfilter;;;;;;;;;;
!#help;filtre les geometries pour eviter les erreurs;;;;;
schema:type_geom;!#type_geom;;;;;#type_geom;filter;1,2;;fin;
+1:;;;;#classe+;_p;;set;;;;
+:;;;;;;;force_pt;;;;
+2:;;;;#classe+;_l;;set;;;;
+:;;;;;;;force_ligne;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#groupe;groupe;;;;;;;;;
!#help;force le groupe;;;;;
!#parametres;groupe;nouveau groupe;;;;;;;;;;
;;;;#groupe;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#classe;classe;att;;;;;;;;
!#help;force la classe;;;;
!#parametres;classe;nouvelle classe;;;;;;;;;;
;;;;#classe;%classe%;%att%;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#ident;groupe;classe;;;;;;;;
!#help;force le groupe et la classe;;;;;
!#parametres;groupe;nouveau groupe;;;;;;;;;;
!#parametres;classe;nouvelle classe;;;;;;;;;;
<#groupe:%groupe%;;;;
<#classe:%classe%;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#prefix;prefix;;;;;;;;;
!#help;prefixe la classe;
!#parametres;prefix; prefixe a ajouter a la classe;;;;;;;;;;
;;;;+#classe;%prefix%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#rename;old;new;;;;;;;
!#help:modifie la classe;
!#parametres;old;chaine a remplacer;
!#parametres;new;chaine de remplacement;;;;;;;;;
;;;;#classe;;#classe;sub;%old%;%new%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#regroupe;groupe;stocke_groupe;;;;;;;;
!#help;force le groupe et le transfere sur un attribut;
!#parametres;groupe;nom du nouveau groupe;
!#parametres;stocke_groupe;nom de l'attribut contenant l'ancien groupe;;;;;;;;;;
;;;;%stocke_groupe%;;#groupe;set;;;fin;
;;;;#groupe;%groupe%;;set;;;fin;
;;;;#schema;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#version;full;;;;;;;;;;
!#help;affiche la version de pyetl;;;;;;;;;;
!#api;version;text;
!#parametres;full(B);version complete 0/1 t/f;
$sans_sortie;1;
;;;;;;;version;%full%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#set;atts;vals;defaut;;;;;;;
!#help;affectation  absolue de champs; ;;;;;;;;;
!#parametres;atts;liste d'attributs a affecter;
!#parametres;vals;liste d attributs source;
!#parametres;defaut;valeur par defaut;
;;;;%atts%;%defaut%;%vals%;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#supp;atts;;;;;;;;
!#help;suppression de champs; ;;;;;;;;;
!#parametres;atts;liste d'attributs a supprimer;
;;;;%atts%;;;supp;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#change;att;old;new;;;;;;;
!#help:change une valeur d'attribut;
!#parametres;old;chaine a remplacer;
!#parametres;new;chaine de remplacement;;;;;;;;;
;;;;%att%;;%att%;sub;%old%;%new%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#garder;atts;;;;;;;;
!#help;ne conserver que certains champs; ;;;;;;;;;
!#parametres;atts;liste d'attributs a conserver;
;;;;%atts%;;;garder;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#attsave;att;nom;ext;;;;;;
!#help;stocke le contenu d'un attribut; ;;;;;;;;;
!#parametres;atts;liste d'attributs a conserver;
;;;;%att%;;%nom%;attsave;;%ext%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cmd;cmd;v1;v2;v3;v4;v5;;;;
!#help;passe une commande a la sauvage; ;;;;;;;;;
!#description;les parametres a renseigner ou pas dependent de la commande
!#parametres;cmd;commande a passer;
!#parametres;v1;champs de sortie;
!#parametres;v2;valeur par defaut;
!#parametres;v3;champs d entree;
!#parametres;v4;param1;
!#parametres;v5;param2;
;;;;%v1%;%v2%;%v3%;%cmd%;%v4%;%v5%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#mod;att;val;repl;;;;;;;
!#help;modification conditionelle de valeurs dans un champs;;;;;;;;;;
!#parametres;att;attribut a traiter;
!#parametres;valeur a rechercher;
!#parametres;valeur de remplacement;
%att%;%val%;;;%att%;%repl%;;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#low;al;;;;;;;
!#help ;passe une liste d attributs en minuscule; ;;;;;;;;;
!#parametres;al;param1liste de champs a passer en minuscule;
;;;;%al%;;;lower;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fanout;;;;;;;;;;
!#help;positionne le fanout a classe avec un mode de traitement par classe
!#variables;format;format de sortie (asc par defaut)
$mode_sortie=C;;;;;;;;;;;
$fanout=class;;;;;;;;;;;
$F_sortie=%format%;asc;;;;;;;;;;
!========================= lecture donnees ============================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#extractm;;;;;;;;
!#help;extraction en mode multiprocesseur;;;;;;;;;;
<#stdvar;;;;;;;;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;;
;;;;X;;;charge;%fich%;
!===========================================================================================;;;;;;;;;;;
&&#define;#extract;niveau;classe;;;;;;;;
!#help;extraction de niveaux ou de classes a partir de fichiers;;;;;;;;;;
!#description;effectue un filtrage apres lecture : peu efficace preferer les filtres de fichier si possible
!#e_s;entree;fichier a lire;
!#e_s;sortie;repertoire destination;
!#parametres;niveau;groupe a selectionner si vide pas de filtrage;
!#parametres;classe;classe a selectionner si vide pas de filtrage;
!#variables;schema;schema d entree sous forme de ficher de description csv
!#variables;multigeom;force les geometries en multiple si vrai(1 ou t)
<#stdvar;;;;;;;;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;;
K:%multigeom%;;;;;;%multigeom%;;multigeom;;;fin;
#groupe;%niveau%;#classe;%classe%;;;;pass-;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#extract+gid;niveau;classe;;;;;;;;;;
!#help;lecture d'un jeu de donnees d un repertoire avec ajout d un gid si necessaire
!#parametres;#extract;;
!#variables;#extract;;
<#extract;%niveau%;%classe%;;;;;;;;;;;
<#gid;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#valide;niveau;classe;;;;;;;;
!#help;validation de niveaux ou de classes par rapport a un schema;;;;;;;;;;
!#description;si le niveau et la classe ne sont pas renseignes tout est traite;;;
!#parametres;niveau;niveau a traiter;
!#parametres;classe;classe a traiter;
!#variables;schema;schema a charger pour validation;
!#variables;#stdvar;
<#stdvar;txt;;;;;;;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;fin;
#groupe;%niveau%;#classe;%classe%;;;;valide_schema;;;fin;10,date_creation
!===========================================================================================;;;;;;;;;;;
&&#define;#analyse;force;;;;;;;;;
!#help;analyse d'un jeu de donnees
!#parametres,force; 1 force la generation du schema (ignore le schema du format);;;;
!#variables;max_conf;nombre de classes maxi d une enum;
$format_schema=csv,xml,sql;;;;;;;;;;;
$max_conf=%max_conf%;40;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
!$F_sortie=#poubelle
K:%force%;;;;;;;#schema;supp;;;;
;;;;;;;schema>;%nom%;%max_conf%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#filtre;exp;;;;;;;;;
!#help;filtrage d un fichier texte avec une regex;;;;;;;;;;
!#parametres;exp;regex de filtrage;
$F_entree=ligne;;;;
contenu;%exp%;;;;;#num_ligne,contenu;print;;;;
!=================================== acces bases de donnees ================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbaccess;acces;base;serveur;type;user;pass;;;;
!#help;positionne des elements d'acces a une base de donnees en direct;;;;;;;;;;
!#description;cree un l equivalent d une entree site_params a la volee;;;
!#description;non stocke dans site_params;
!#description;cette macro s utilise en complement d une autre;
!#parametres;acces;nom du groupe;
!#parametres;base;nom de la base de donnees;
!#parametres;serveur;serveur et port;
!#parametres;type;type de la base de donnees;
!#parametres;user;utilisateur de connection;
!#parametres;pass;mot de passe;
$base_%acces%=%base%;;;;;;;;;;;
$server_%acces%=%serveur%;;;;;;;;;;;
$db_%acces%=%type%;;;;;;;;;;;
$sitedef_%acces%='ok';;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#initdb;acces;nomfich;;;;;;;
!#help;positionne des elements d'acces a une base de donnees;;;;;;;;;;
$F_sortie=%format%;%F_sortie%;csv;;;;;;;;;
$format_schema=%format_schema%;csv,xml;;;;;;;;;;
$nom=%nomfich%;%acces%;extraction;;;;;;;;;
$xmlheader=%xmlheader%;;;;;;;;;;;
$xmlalias=%alias%;;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbschema;acces;niveau;classe;nom;;;;;;
!#help;analyse une base de donnees;;;;;;;;;;
!#api;dbschema;xml;no_in
!#parametres;acces;base a analyser;
!#parametres;niveau;schema a analyser (exp reg);
!#parametres;classe;classe a analyser (exp reg);
!#parametres;nom;nom du fichier de sortie (exp reg);
!#variables;mod;selection (V T M =)
<#initdb;%acces%;%nom%;;;;
$force_schema=%etendue%;dbschema;;;;;;;;;;;
db:%acces%;%niveau%;%classe%;;;%nom%;#nombase;dbschema;%mod%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fileschema;acces;;;;;;
db:%acces%;;;;;;;dbschema;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbclean;acces;niveau;classe;nom;mod;;;;;
!#help;cree un script de reset de la base de donnees;;;;;;;;;;
!<#initdb;%acces%;%nom%;;;;
db:%acces%;%niveau%;%classe%;;;;;dbclean;T=;%nom%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbwrite;dest;niveau;classe;attributs;;;;;;
!#help;chargement dans une base de donnees d'une base de données;;;;;;;;;;
<#initdb;%dest%;;;;;
db:%dest%;%niveau%;%classe%;;;;%attributs%;dbwrite;;;;
!;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbextract;acces;niveau;classe;attribut;valeur;ordre;;;;
!#help;extraction d'un jeu de donnees d'une base de données;;;;;;;;;;
<#initdb;%acces%;%nom%;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;fin;
K:%dest%;;;;;;;;pass;;;fin;
!K:%dest%;db:%base#dest%;;;;schema_sortie;;;dbschema;;;fin;
db:%acces%;%niveau%;%classe%;%attribut%;;%valeur%;;dbalpha;%mod%;%ordre%;;
!;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbdump;acces;niveau;classe;rep_sortie;log;;;
!#help;extraction d'un jeu de donnees d'une base de donnees avec un programme externe;;;;;;;;;;
<#stdvar;;;;;;;;
db:%acces%;%niveau%;%classe%;;;;;dbextdump;%rep_sortie%;%log%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#geoextract;acces;niveau;classe;rel_geo;buffer;champ;;;;
!#help;extraction d'un jeu de donnees d'une base par contour(le contour est l objet d entree)
!#parametres;accces;base de donnees a acceder ( doit etr definie dans site_params)
!#parametres;niveau;schema des classes a extraire (exp reg ou in:nom de fichier)
!#parametres;classe;classes a extraire (exp reg)
!#parametres;rel_geo;relation geometrique: dans_emprise,dans,intersecte,contient ou inverse en commencant par ! (!dans...)
!#parametres;buffer;taille du buffer
$mode_sortie=D;;;;;;;;;;;
<#initdb;%acces%;;;;;
$rel_geo=%rel_geo%;dans_emprise;;;;;;;;;;;
K:%emprise%;$sans_entree=1;;;;
K:%emprise%;;;;;nom;emprise;;creobj;emprise;1;
K:%emprise%;;;;;;%emprise%;;addgeom;2;;fin;;# on ajoute une geometrie de ligne
db:%acces%;%niveau%;%classe%;%rel_geo%;%champ%;%buffer%;;dbgeo>;%mod%;%ordre%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbextract+gid;acces;niveau;classe;attribut;valeur;;;;;
!#help;lecture d'un jeu de donnees d' une base avec ajout d un gid si necessaire p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
<#dbextract;%acces%;%niveau%;%classe%;%attribut%;%valeur%;;;;;;
<#gid;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbrequest;acces;requete;niveau;classe;;;;
!#help;recuperation d'un jeu de donnees par requete directe;;;;;;;;;;
<#initdb;%acces%;%nom%;;;;
db:%acces%;%niveau%;%classe%;;;;;dbreq;%requete%;%nom%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dblist;acces;requete;;;;
!#help;affichage d'un jeu de donnees par requete directe dans une variable;;;;;;;;;;
db:%acces%;;;;P:result;;;dbreq;%requete%;;;;
;;;;;;;printv;result;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dir;;;;;;
!#help;affichage d une liste recursive de fichiers;;;;;;;;;;
$F_entree=dir;
;;;;;;;pass;;;;

!========================= conversion ======================================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#to_sigli;;;;;;;;;;
!#help;preparation d'un jeu de donnees formatage standard sigli p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
$format=sql;;;;;;;;;;;
<#extract+gid;;;;;;;;;;;
<#att_sigli_std;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#ora2pg;;;;;;;;;;
!#help;passage de oracle vers postgis;;;;;;;;;;
$codec_sortie=utf-8;;;;;;;;;;;
$F_sortie=sql:sigli;;;;;;;;;;;
<#dbextract+gid;;;;;;;;;;;
<#cmin;;;;;;;;;;;
p:groupe;;;;#groupe;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#sigli2elyx;;;;;;;;;;
!#help;passage de sigli vers elyx : sortie asc suppression GID renommage attributs modifies;;;;;;;;;;
$codec_sortie=cp1252;;;;;;;;;;;
<#dbextract;;;;;;;;;;;
$F_sortie=asc;;;;;;;;;;;
type_entite;;;;type;;type_entite;ren;;;fin;
gid;;;;#gid;;gid;set;;;fin;
+:;;;;;;gid;supp;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#reproj;orig;dest;grille;;;;;;;
!#help;convertit des coordonees du systeme orig vers dest;;;;;;;;;;
;;;;;%orig%;;reproj;%dest%;%grille%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#g2p;lon;lat;;;;;;;;
!#help;convertit des coordonees lat long en attribut en point cc48;;;;;;;;;;
;;;;;0;%lon%,%lat%;setpoint;;;fin;
;;;;;LL;;reproj;CC48;NG;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cus2cc48;;;;;;;;;;
!#help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;L1;;reproj;CC48;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cc2cus;;;;;;;;;;
!#help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;CC48;;reproj;L1;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#ll2cus;;;;;;;;;;
!#help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;LL;;reproj;CC48;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cc482ll;;;;;;;;;;
!#help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;CC48;;reproj;LL;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#2p;x;y;srid;;;;;;;
!#help;convertit des coordonees x,y en attribut en point;;;;;;;;;;
;;;;;0;%x%,%y%;setpoint;%srid%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#2d;;;;;;;;;
!#help;convertit des coordonees 2d;;;;;;;;;;
;;;;;;;geom2D;;;fin;
!============================ manipulation schemas =========================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fusion_schema;nom;;;;;;;;;
!#help;fusion de schemas issus de traitements paralleles p:schema: racine des schemas a lire (*) lecture multiple >nom: nom du schema a creer;;;;;;;;;;
$format_schema=csv,xml;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$nom=%nom%;fusion;;;;;;;;;;
;;;;#schema;%nom%;;lire_schema;%schema%;csv;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#schema_sigli;nom_schema=#schemas;;;;;;;;;
!#help;ajoute les attributs standard a un schema
;;;;;;;start;%nom_schema%;;fin
<#att_sigli_modif;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cree_sql;nom;dialecte;;;;;;;
!#help;conversion de schemas en sql;
!#description;schema: racine des schemas a lire (*) lecture multiple;
!#parametres;nom: nom du schema a creer;;;;;;;;;;
!#parametres;dialecte: type de sql a creer;;;;;
$sans_entree=True;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$dialecte=%dialecte%;sigli;;;;;;;;;;
$nom=%nom%;donnees;;;;;;;;;;
$codec_entree=%codec_csv%;;;;;
$format_schema=sql:%dialecte%,csv;;;;;;;;;;;
!;;;;;;;start;;;;
!;;;;;;;reel;;;;
;;;;#schema;;;lire_schema;%nom%;csv;;
<#att_sigli;%modif%
!===========================================================================================;;;;;;;;;;;
&&#define;#cree_schema;nom;dialecte;modif;;;;;;
!#help;conversion de fichiers de structure en schema sql;
!#parametres;nom;racine des fichiers de structure;
!#parametres;dialecte;type de sql a creer;;;;;
!#parametres;modif; 0/1 indique si la classe doit etre modifiee;;;;;
$nom=%nom%;schema;;;;
$dialecte=%dialecte%;sigli;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$format_schema=sql:%dialecte%,csv;;;;;;;
$enums=%enums%;enumerations;;;;
$schemas_a_sortir=%nom%
;;;;;%nom%;;cree_schema>;[#classe];%enums%;
<#att_sigli;%modif%
!============================= manipulation des parametres =================================;;;;;;;;;;fin;
!===========================================================================================;;;;;;;;;;fin;
&&#define;#site_params;key;;;;;;;;fin;
!#help;affichage des parametres de connection stockes;;;;;;;;;fin;
$sans_sortie=True;;;;;;;;;;fin;
$_entree=%_paramdir%\site_params.csv;;;;;;;;;;fin;
$force_schema=0;;;;;;;;;;fin;
$clef_crypt=%key%;rien;;;;
;;;;;;;pass;;;;
clef;&&#set;;;groupe;;valeur;set;;;;
+:;;;;;;groupe;print>;---------;noms;fin;
clef;^passwd;p:printpv;!force;valeur;******;;set;;;fin;
clef;\*\*passwd;p:key;;valeur;;valeur;decrypt;%clef_crypt%;;fin;
|:;;;;clef;passwd;;set;;;
clef;!:null;;;;;clef,valeur;print>;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#pwcrypt;clef;;;;;;;;;
!#help;crypte les mots de passe;;;;;;;;;;
!$_entree=%_paramdir%\site_params.csv;;;;;;;;;;;
!$_sortie=%_paramdir%;;;;;;;;;;;
$F_sortie=csv;;;;;;;;;;;
$mode_sortie=A;;;;;;;;
$separ_csv_out=#std;;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
$key=%clef%;%masterkey%;;;;;;;
;;;;#classe;site_params_c;;set;;;;
clef;^passwd;;;valeur;;valeur;crypt;%key%;;;
+:;;;;+clef;**;;set;;;fin;
clef;masterkey;;;valeur;;valeur;crypt;;;;cryptolevel=0
!clef;!'';;;;;clef,valeur;print;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#mastercrypt;val;;
!#help;crypte un element avec la masterkey
$sans_entree=1;;;
;;;;;;;start;;;;
;;;;v2;%val%;X;crypt;%masterkey%;;;
;;;;;;v2;print;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#print;;;;;;;;;;
;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#printparams;;;;;;;;;;
!#help;affichage;;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
;;;;;;*;print>;#classe;noms;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#liste_params;clef;val;
!#help;liste les parametres d acces aux bases;
;;;;pgroup;%val%;;paramgroups;%clef%;
!===========================================================================================;;;;;;;;;;;
&&#define;#printvar;var;;;;;;;;;
!#help;affichage variable;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
;;;;%var%;%%var%%;;set;;;
;;;;;%var%;;print>;#classe;noms;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#pyetl_init_db;;;;;
!#help;initialise le schema pyetl pour travailler en base de donnees;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$format_schema=sql,csv;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$nom=pyetl;;;;;;;;;;;
$schema=%_progdir%\moteur\db_struct\pyetl;;;;;;;;;;;
;;;;#schema;%nom%;;lire_schema;%schema%;csv;fin;
!========================================mode batch===================================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_list_batch;bdef;sortie;;;;;;;
!#help;liste des batchs definis en base ;;;;;;;;;;
$mode_sortie=A;;;;;;;;;;;
$F_sortie=%sortie%;#print;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$bdef=%bdef%;batchmode;;;;;;;;;;
$sortie=%sortie%;#print;;;;;;;;;;
$#%bdef%;;;;;;;;;;;
$ordrebatch=ordre,famille;;;;;;;;;;;
K:%sortie%;$sans_sortie=True
<#dbextract;%batchserver%;%batchschema%;%batchtable%;;;%ordrebatch%;;;;;
is:valid_date;[jours];;;;;;pass;;;;
p:sortie;#print;;;;;;tmpstore;;;;
|:;;;;;;nom,famille,ordre,commentaire,actif;print>;;;;
!;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_batch;nom_batch;famille_batch;force;;;;;;;
!#help;passe les batchs actifs;;;;;;;;;;
<#db_list_batch;;csv;;;;;;;;;
P:nom_batch;;;;;;;pass;;;;
+:nom;!%nom_batch%;;;;;;pass>;;;;
P:famille_batch;;;;;;;pass;;;;
+:famille;!%famille_batch%;;;;;;pass>;;;;
P:force;;;;;;;pass;;;;
+sinon:is:valid_date;[jours];;;;;;pass-;
|:actif;true;;;;;;pass-;
;;;;succes;;;batch;;;;
;;;;;;;pass>;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#timeselect;var;;;;;;;;;
!#help;determine si un batch est executable en fonction de l'heure;;;;;;;;;;
;;;;#_timeselect;0;;set;
is:valid_time;[%var%];;;#_timeselect;1;;set;
!===========================================================================================;;;;;;;;;;;
&&#define;#batch_rt;;;;;;;;;;
!!#help;lancement de scripts en boucle depuis un fichier de jobs (mode temps reel);;;;;;;;;;;
actif;1;;;succes;;;batch;boucle;#timeselect:intervalle;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_batch_rt;bdef;;;;;;;;;
!#help;lance le scheduler sur une liste de taches en base lecture unique;;;;;;;;;;
$bdef=%bdef%;batchmode;;;;;;;;;;
$#%bdef%;;;;;;;;;;;
<#dbextract;%batchserver%;%batchschema%;%batchscheduler%;;;;;;;;
actif;true;;;succes;;;batch;boucle;#timeselect:intervalle;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_batch_suivi;bdef;;;;;;;;;
!#help;lance le scheduler sur une liste de taches modifiables en base;;;;;;;;;;
$bdef=%bdef%;batchmode;;;;;;;;;;
$#%bdef%;;;;;;;;;;;
;;;;succes;#dbextract:%batchserver%:%batchschema%:%batchscheduler%;;batch;boucle;#timeselect:intervalle;;;
actif;true;is:valid_time;[intervalle];succes;;;batch;;;;multi=4;
!===========================================================================================;;;;;;;;;;;
&&#define;#scriptodb;nom;dest;;;;;;;;
!#help;charge un script en base;;;;;;;;;;
$#dest;;;;;;
<#extract:%nom%

!===========================================================================================;;;;;;;;;;;
&&#define;#runsql;nom;dest;;;;;;;;
!#help;lancement script_sql;;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
!$#%dest%;;;;;;;;;;;
db:%dest%;;;;;%nom%;;runsql;%log%;%sortie%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#runproc;nom;dest;params;;;;;;;
!#help;lancement fonction_sql;;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$#%dest%;;;;;;;;;;;
db:%dest%;;;;;%params%;;runproc;%nom%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#autoload;dest;;;;;;;;;
!#help;charge les derniers resultats en base de donnees;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$#%dest%;%dest%;;;;;;;;;;
db:%dest%;;;;;%derniere_sortie%;;runsql;%log%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#zip;source;destination;;;;;;;;
!#help;zippe les resultats;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
;;;;;%source%;;archive;%destination%;%_sortie%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#md5;source;;;;;;;;
!#help;calcule une somme md5 sur le fichier;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
;;;;;%source%;;checksum;md5;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#filter;champ;filtre;;;;;;;;
!#help;mange tous les objets qui ne satisfont pas la condition ;;;;;;;;;;
!;;;;;;;pass;;;;
%champ%;%filtre%;;;;;;pass-;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#jette;;;;;;;;;;
!#help;mange tous les objets;;;;;;;;;;
;;;;;;;pass>;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#set;atts;vals;defaut;;;;;;;
!#help ;affectation  absolue de champs; ;;;;;;;;;
;;;;%atts%;%defaut%;%vals%;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cmd;cmd;v1;v2;v3;v4;v5;;;;
!#help ;passe une commande a la sauvage; ;;;;;;;;;
;;;;%v1%;%v2%;%v3%;%cmd%;%v4%;%v5%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#mod;att;val;repl;;;;;;;
!#help ;modif conditionelle de valeurs dans un champs; ;;;;;;;;;
%att%;%val%;;;%att%;%repl%;;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#indb;acces;;;;;;;;;
!#help;precharge des donnees depuis une base pour comparaison;;;;;;;;;;
db:%acces%;[#niveau];[#classe];;;;;dbalpha;=;;fin;
;;;;;P:#pk;;sortir;#store;nom;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#bdiff;acces;;;;;;;;;
!#help;sort un objet s il n existe pas en base;;;;;;;;;;
[#niveau];;[#classe];;cmp;P:#pk;;preload;#indb:acces;;fin;
P:#pk;!in:#cmp;;;;;;pass>;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#grid;x_orig;y_orig;pas;cases;;;;;;
!#help;repartit les objets selon une grille;;;;;;;;;;
;;;;%case%_x;;;gridx;%x_orig%;%pas%;;
;;;;%case%_y;;;gridy;%y_orig%;%pas%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#upload;fich;dest;destdir;;;;
!#help;charge des elements par ftp;;;;;;;;;;
$#ftp_%dest%;;;;;;
$sans_entree=1;;
$fichier=%fich%;%derniere_sortie%;;
$destdir=%destdir%;.;;
;;;;;%fichier%;;ftp_upload;ftp_%dest%;%destdir%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#s3upload;fich;acces;dest;;;;
!#help;charge des elements en s3;;;;;;;;;;
$fichier=%fich%;%derniere_sortie%;;
$sans_entree=1;;
$#%acces%;;;;;;
;;;;;%fichier%;;s3upload;%dest%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#ftpdownload;fich;acces;accdir=.;;;;
!#help;charge des elements par ftp;;;;;;;;;;
$#ftp_%acces%;;;;;;
;;;;;%fich%;;ftp_download;ftp_%acces%;%accdir%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#httpdownload;url;dest;rep;;;;
!#help;charge des elements en http;;;;;;;;;;
;;;;;%url%;;download;%rep%;%dest%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#geocode;adresse;filtres;;;;
!#help;geocode des elements;commande;parametres;;;;;;;;
"$separ_csv_out=\;";;;
$mode_sortie=D;;;;
;;;;;;%adresse%;geocode;%prefix%;%filtres%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#geocode2cus;adresse;filtres;;;;
!#help;geocode des elements et sort des points en cc48 cus;commande;parametres;;;;;;;;
"$separ_csv_out=\;";;;
;;;;;;%adresse%;geocode;%prefix%;%filtres%;;
<#g2p;latitude;longitude;
!===========================================================================================;;;;;;;;;;;
&&#define;#run;prog;params;;;;
!#help;execute une commande externe;commande;parametres;;;;;;;;
;;;;;;;run;%prog%;%params%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#editparams;perso;;;;;
$fich=%_paramdir%;;
K:perso;$fich=%_paramperso%;;
;;;;P:_;;;run;notepad %fich%\site_params.csv;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#debug;;;;;;
;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#log;message;level;;;;
;;;;;;;log;%message%;%level%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#sleep;duree;;;;;
;;;;;%duree%;;sleep;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#aduser;nom;clef;;;;
!#help;recupere un nom d utilisateur sur active directory ou LDAP;
!#parametres;nom;nom de l utilisateur;
!#parametres;clef;;
K:ADserver;$#%ADserver%;
;;;;P:x;%nom%;;adquery;user;%clef%;;
;;;;;%x%;;print;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#adquery;condition;element;clef;;;;
!#help;passe une requete LDAP;
!#parametres;condition;clause de recherche;
!#parametres;element;element recherche;
!#parametres;clef;items a recuperer;
K:ADserver;$#%ADserver%;
;;;;P:x;%condition%;;adquery;%element%;%clef%;;
;;;;;P:x;;print;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#moi;;;;;
!#help;affiche le nom de l utilisateur courant
!#variables;ADserver;identification du serveur AD/LDAP a utiliser si pas de defaut systeme
K:ADserver;$#%ADserver%;
;;;;P:_username;%_login%;;adquery;user;;debug
!===========================================================================================;;;;;;;;;;;
&&#define;#test;n1;n2=1;a;;;;
!#help;test des variables;;;
$#%a%;
$test_v1=%n1%;;;;;
$test_v2=%n2%;;;;;
;;;;;;;printv>;%test_v1%;;;
